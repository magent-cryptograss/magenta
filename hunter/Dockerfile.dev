FROM ubuntu:latest

# Install packages from list
COPY packages.txt /tmp/
RUN apt-get update \
    && xargs -a /tmp/packages.txt apt-get install -y

RUN mkdir /var/run/sshd

# Install code-server
RUN curl -fsSL https://code-server.dev/install.sh | sh

# Create a non-root user  
RUN useradd -m -s /bin/bash magent

# Copy SSH key as ROOT and set up permissions (optional for local dev)
# Create the directory first
RUN mkdir -p /home/magent/.ssh \
    && chown -R magent:magent /home/magent/.ssh \
    && chmod 700 /home/magent/.ssh

# Copy SSH key if it exists (for SSH access to container)
# For local dev, you can skip this and use docker exec instead
COPY id_ed25519.pub* /tmp/
RUN if [ -f /tmp/id_ed25519.pub ]; then \
        cat /tmp/id_ed25519.pub >> /home/magent/.ssh/authorized_keys \
        && chmod 600 /home/magent/.ssh/authorized_keys \
        && rm /tmp/id_ed25519.pub; \
    fi

# Install Claude tools (skip Playwright/Puppeteer for local dev - not needed)
RUN npm install -g @anthropic-ai/sdk @anthropic-ai/claude-code

# Install Docker CLI
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update \
    && apt-get install -y docker-ce-cli

# Install GitHub CLI (following official docs)
RUN (type -p wget >dev/null || (apt update && apt install wget -y)) \
    && mkdir -p -m 755 /etc/apt/keyrings \
    && out=$(mktemp) && wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    && cat $out | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
    && chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
    && mkdir -p -m 755 /etc/apt/sources.list.d \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt update \
    && apt install gh -y

USER magent
WORKDIR /home/magent

# Create directories and install Playwright browsers as magent user
RUN mkdir -p /home/magent/.config/gh

USER root

# Note: PostgreSQL runs in separate container (see docker-compose.local.yml)
# No local PostgreSQL installation needed

COPY container-startup.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/container-startup.sh

# Expose ports (removed 5432 - postgres runs in separate container)
EXPOSE 22 8080

CMD ["/usr/local/bin/container-startup.sh"]
