---
- name: Clone or update magenta repository
  git:
    repo: https://github.com/magent-cryptograss/magenta.git
    dest: "{{ base_dir }}/magenta-source"
    version: production
    force: yes

- name: Get docker group GID from host
  shell: "getent group docker | cut -d: -f3"
  register: docker_gid

- name: Build magenta-arthel base image
  command: docker compose -f docker-compose-build.yml build --build-arg DOCKER_GID={{ docker_gid.stdout }}
  args:
    chdir: "{{ base_dir }}/magenta-source/hunter"

- name: Verify image was built
  command: docker images magenta-arthel:latest --format "{% raw %}{{.Repository}}:{{.Tag}}{% endraw %}"
  register: image_check
  failed_when: "'magenta-arthel:latest' not in image_check.stdout"
