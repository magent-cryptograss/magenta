---
# Data migration - restore database from provided dump file
# Usage: ansible-playbook ... -e "db_dump_file=/path/to/backup.dump"
# Note: The backup file copy is started early in the playbook (async) and we wait for it here

- name: Wait for async database backup copy to complete
  async_status:
    jid: "{{ db_copy_job.ansible_job_id }}"
  register: db_copy_result
  until: db_copy_result.finished
  retries: 180  # 180 * 10 seconds = 30 minutes max
  delay: 10
  delegate_to: localhost
  become: no
  when: db_copy_job is defined and db_copy_job.ansible_job_id is defined

- name: Set permissions on copied database dump
  file:
    path: /tmp/magenta_memory.dump
    mode: '0600'
  when: db_dump_file is defined

- name: Wait for postgres container to be ready
  shell: docker exec magenta-postgres pg_isready -U magent
  register: pg_ready
  until: pg_ready.rc == 0
  retries: 30
  delay: 2

- name: Check if database already has data
  shell: docker exec magenta-postgres psql -U magent -d magenta_memory -t -c "SELECT COUNT(*) FROM conversations_message;"
  register: existing_data
  ignore_errors: yes

- name: Get highest message number from existing database
  shell: docker exec magenta-postgres psql -U magent -d magenta_memory -t -c "SELECT COALESCE(MAX(message_number), 0) FROM conversations_message;"
  register: max_message_number
  when: existing_data is defined and not existing_data.failed and existing_data.stdout | trim | int > 0

- name: Restore database dump (only if database is empty)
  shell: |
    docker cp /tmp/magenta_memory.dump magenta-postgres:/tmp/
    docker exec magenta-postgres pg_restore -U magent -d magenta_memory --if-exists -c -F c /tmp/magenta_memory.dump
  when: existing_data.stdout | trim | int == 0 or existing_data.failed
  register: restore_result
  ignore_errors: yes

- name: Incremental import - enable dblink extension
  shell: docker exec magenta-postgres psql -U magent -d magenta_memory -c "CREATE EXTENSION IF NOT EXISTS dblink;"
  when: existing_data is defined and not existing_data.failed and existing_data.stdout | trim | int > 0
  ignore_errors: yes

- name: Incremental import - restore dump to temporary database
  shell: |
    docker exec magenta-postgres psql -U magent -d postgres -c "DROP DATABASE IF EXISTS magenta_memory_temp;"
    docker exec magenta-postgres psql -U magent -d postgres -c "CREATE DATABASE magenta_memory_temp;"
    docker exec magenta-postgres pg_restore -U magent -d magenta_memory_temp -F c /tmp/magenta_memory.dump
  when: existing_data is defined and not existing_data.failed and existing_data.stdout | trim | int > 0
  register: incremental_restore
  ignore_errors: yes

- name: Incremental import - copy new messages from temp to main database
  shell: |
    docker exec magenta-postgres psql -U magent -d magenta_memory -c "
      INSERT INTO conversations_message
      SELECT * FROM dblink('dbname=magenta_memory_temp user=magent',
        'SELECT * FROM conversations_message WHERE message_number > {{ max_message_number.stdout | trim }}')
      AS t(id uuid, sender_id varchar, content jsonb, created_at timestamptz, parent_id uuid,
           context_window_id uuid, message_number integer, client_message_id varchar,
           client_version varchar, polymorphic_ctype_id integer);
    "
  when: incremental_restore is defined and incremental_restore.rc == 0
  register: incremental_import
  ignore_errors: yes

- name: Incremental import - drop temporary database
  shell: docker exec magenta-postgres psql -U magent -d postgres -c "DROP DATABASE IF EXISTS magenta_memory_temp;"
  when: incremental_restore is defined
  ignore_errors: yes

- name: Count messages in source dump file
  shell: pg_restore -l /tmp/magenta_memory.dump | grep -c "TABLE DATA.*conversations_message" || echo "0"
  register: dump_message_count
  when: restore_result is defined and restore_result.changed | default(false)
  ignore_errors: yes

- name: Count messages after restore
  shell: docker exec magenta-postgres psql -U magent -d magenta_memory -t -c "SELECT COUNT(*) FROM conversations_message;"
  register: restored_message_count
  when: restore_result is defined and restore_result.changed | default(false)

- name: Set expected message count fact
  set_fact:
    expected_message_count: "{{ restored_message_count.stdout | trim }}"
  when: restore_result is defined and restore_result.changed | default(false)

- name: Count messages after migration
  shell: docker exec magenta-postgres psql -U magent -d magenta_memory -t -c "SELECT COUNT(*) FROM conversations_message;"
  register: final_message_count

- name: Display migration results
  debug:
    msg: |
      Database migration status:
      - Existing messages before: {{ existing_data.stdout | trim if (existing_data is defined and existing_data.stdout is defined and not existing_data.failed) else 'N/A' }}
      - Migration type: {{ 'FULL RESTORE' if (restore_result is defined and restore_result.changed | default(false)) else 'INCREMENTAL IMPORT' if (incremental_import is defined and incremental_import.changed | default(false)) else 'SKIPPED (no changes)' }}
      - Messages imported: {{ (final_message_count.stdout | trim | int) - (existing_data.stdout | trim | int) if (incremental_import is defined and incremental_import.changed | default(false)) else 'N/A' if (restore_result is not defined or not restore_result.changed | default(false)) else final_message_count.stdout | trim }}
      - Total messages after: {{ final_message_count.stdout | trim }}

- name: Clean up dump file on hunter
  file:
    path: /tmp/magenta_memory.dump
    state: absent
