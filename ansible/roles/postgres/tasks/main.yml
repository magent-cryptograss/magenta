---
- name: Create PostgreSQL data directory
  file:
    path: "{{ base_dir }}/postgres-data"
    state: directory
    mode: '0755'

- name: Create PostgreSQL docker-compose file
  copy:
    dest: "{{ base_dir }}/docker-compose-postgres.yml"
    content: |
      version: '3.8'
      services:
        postgres:
          image: postgres:16
          container_name: magenta-postgres
          environment:
            POSTGRES_PASSWORD: {{ postgres_password }}
            POSTGRES_DB: {{ postgres_db }}
            POSTGRES_USER: magent
          volumes:
            - {{ base_dir }}/postgres-data:/var/lib/postgresql/data
          networks:
            - magenta-net
          restart: unless-stopped

      networks:
        magenta-net:
          name: magenta-net
          driver: bridge

- name: Start PostgreSQL container
  command: docker compose -f {{ base_dir }}/docker-compose-postgres.yml up -d
  args:
    chdir: "{{ base_dir }}"

- name: Check if database dump exists
  stat:
    path: "{{ base_dir }}/database-dump.sql"
  register: db_dump

- name: Import database dump if it exists
  shell: |
    docker exec -i magenta-postgres psql -U magent -d {{ postgres_db }} < {{ base_dir }}/database-dump.sql
  when: db_dump.stat.exists
